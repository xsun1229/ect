---
title: "Getting Started "
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{getting_started}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>",
  eval = FALSE
)
```

```{r setup, include=FALSE, eval=T}
library(ect)
```


We provide two main functions and one auxiliary function in this package:

**Main functions**

1. `prune_snps()` — Select independent SNPs

Selects independent SNPs using PLINK clumping and LD pruning.

2. `ECT()` — Effect Consistency Test

Performs an adaptive resampling test to assess whether SNP effect directions on an outcome (GWAS trait) are consistent with those on an exposure (pathway factor).

**Auxiliary function**

1. `run_snps_assoc()` — Run PLINK-based SNP associations

Automates PLINK linear association testing for multiple SNPs and phenotypes (factors) in parallel, with optional MAF annotation. Helps to prepare the input for `ECT()`


## Install ECT

Use “devtools” to install the latest version of ect from GitHub:


```{r eval=F, echo=T}
install.packages("devtools")
devtools::install_github("xsun1229/ect")
```

Currently, ect has only been tested on Linux systems.

## Select independent SNPs

The `prune_snps()` function performs two-stage SNP pruning to identify a set of approximately independent lead variants from a GWAS summary statistics file.
It integrates PLINK-based clumping, distance-based filtering, and LD-based pruning using a user-specified PLINK genotype reference panel.

This function is designed for downstream analyses that require independence among variants, such as variant–factor association tests.

### What the function does

The pruning proceeds in **three sequential steps**:

1. PLINK clumping (primary selection of lead SNPs)

This step uses the GWAS summary statistics together with a PLINK genotype reference (`bfile`) to perform LD clumping.  
The following PLINK thresholds are used by default:

  - `--clump-p1 5e-8`  
  - `--clump-p2 1e-3`  
  - `--clump-r2 0.1`  
  - `--clump-kb 1000`

Clumping produces an initial set of **approximately independent lead variants**.

2. Distance-based pruning

  - For SNPs retained after clumping, any SNP located within **±1 Mb** of a more significant SNP is removed.  
  - This step enforces **spatial independence**, giving priority to SNPs with smaller p-values.

3. LD-based pruning

- Pairwise LD (`r²`) is computed using PLINK for the remaining SNPs.  
- SNPs with **r² > 0.1** relative to previously retained variants are removed.

### Final output

After completing these steps, the function returns a set of **independent, genome-wide significant variants**, ready for downstream analyses such as association testing or ACAT aggregation.


### Usage 

```{r eval=F, echo=T}
prune_snps(
  file_sumstats,
  plink_path,
  bfile,
  out.dir,
  out.pref,
  clean_up = FALSE
)
```


| Argument            | Description                                                                                                |
| ------------------- | ---------------------------------------------------------------------------------------------------------- |
| **`file_sumstats`** | Path to the GWAS summary statistics file. Must contain columns `SNP`, `CHR`, `BP`, and `P`.                |
| **`plink_path`**    | Path to the PLINK executable (e.g., `/usr/bin/plink`).                                                     |
| **`bfile`**         | PLINK binary file prefix (`.bed/.bim/.fam`) used as the LD reference panel.                                |
| **`out.dir`**       | Directory where intermediate and final result files are stored. A subdirectory is created automatically.   |
| **`out.pref`**      | Prefix used for naming PLINK outputs and final result files.                                               |
| **`clean_up`**      | If `TRUE`, temporary PLINK files and intermediate subdirectories are deleted after the function completes. |


### Example 

```{r eval=FALSE}
file_sumstats <- system.file("extdata", "example_sumstats.txt", package = "ect")
bfile <- sub("\\.bed$", "", system.file("extdata/example.bed", package = "ect"))

pruned_snps <- prune_snps(
  file_sumstats = file_sumstats,
  plink_path = plink_path,
  bfile = bfile,
  out.dir = tempdir(),
  out.pref = "example",
  clean_up = TRUE
)

print(pruned_snps)

```



## Effect Consistency Test

The `ECT()` function performs an **adaptive resampling-based Effect Consistency Test (ECT)** to evaluate whether SNP effect sizes on an outcome (e.g., a GWAS trait) are **consistent with** their effects on an exposure variable (e.g., a pathway-derived expression factor).

The method compares the **observed R²** from a no-intercept regression of outcome effects on exposure effects against a **null distribution** generated by permuting the outcome effect sizes.


### What the function does

The ECT proceeds in the following steps:

1. Select supporting SNPs  

  - Supporting SNPs are defined as those with exposure-side p-values below the **FDR threshold** (`snp_fdr_cutoff`, default 0.2).  
  - The test is only performed if the number of supporting SNPs ≥ `num_snp_cutoff` (default 3).

2. Fit the observed regression  

A no-intercept model is fitted:

\[
\beta_{\text{outcome}} = \gamma \cdot \beta_{\text{exposure}} + \varepsilon,
\]

and the observed **R²** and regression **p-value** are calculated.

3. Adaptive resampling  

To assess whether the observed R² deviates from the null, outcome effect sizes are permuted:

  - Resampling occurs in **stages**, defined by `resample_stages` (e.g., 1,000 → 10,000 → 1,000,000).  
  - At each stage, the empirical p-value is updated.  
  - Resampling stops early if the empirical p-value exceeds the corresponding threshold in `p_thresholds`.  
  - Otherwise, the next resampling stage is triggered.

---

4. Final output  

The function returns an empirical p-value (`p_ECT`), the observed R² (`r_std`), the standard regression p-value (`p_std`), and the number of supporting SNPs used.

If there are insufficient supporting SNPs, the function returns a placeholder row indicating that the test was not performed.

### Usage

```{r eval=F, echo=T}
ECT(
  assoc_pair,
  factor_name,
  num_snp_cutoff = 3,
  snp_fdr_cutoff = 0.2,
  seeds = 1000,
  resample_stages = c(1000, 10000, 1e6),
  p_thresholds = c(0.1, 0.001),
  col_beta_exposure = "beta.exposure",
  col_beta_outcome = "beta.outcome",
  col_pval_exposure = "pval.exposure"
)

```

| Argument              | Description                                                                                                                                                    |
| --------------------- | -------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| **assoc_pair**        | Data frame containing association summary statistics for a factor, with columns specified by `col_beta_exposure`, `col_beta_outcome`, and `col_pval_exposure`. |
| **factor_name**       | Name of the factor or pathway being tested.                                                                                                                    |
| **num_snp_cutoff**    | Minimum number of supporting SNPs required to perform the test (default: 3).                                                                                   |
| **snp_fdr_cutoff**    | FDR cutoff for selecting supporting SNPs (default: 0.2).                                                                                                       |
| **seeds**             | Base seed for generating reproducible permutations (default: 1000).                                                                                            |
| **resample_stages**   | Vector indicating resampling sizes for each adaptive stage (default: 1e3, 1e4, 1e6).                                                                           |
| **p_thresholds**      | P-value thresholds used to decide whether to continue to the next resampling stage.                                                                            |
| **col_beta_exposure** | Column name for exposure effect sizes (default: `"beta.exposure"`).                                                                                            |
| **col_beta_outcome**  | Column name for outcome effect sizes (default: `"beta.outcome"`).                                                                                              |
| **col_pval_exposure** | Column name for exposure p-values (default: `"pval.exposure"`).                                                                                                |

The function returns a data frame containing:

  - factor_name — the tested factor/pathway
  - p_std — p-value from the observed regression
  - r_std — R² from the observed regression
  - p_ECT — empirical p-value from adaptive resampling
  - num_supp_SNP — number of supporting SNPs used in the test

If the number of supporting SNPs < num_snp_cutoff, a placeholder row is returned.

### Example

We provide an example using a small demonstration dataset included in the package.  

This dataset contains SNP-level association summary statistics that have already been **harmonized with the GWAS** (i.e., aligned alleles, matched SNPs, and retained relevant columns).


```{r eval=T, echo=T}

dat <- readRDS(
  system.file("extdata", "example_assoc_output.RDS",
              package = "ect")
)

print(head(dat))

```

To keep the example computationally light, we reduce the number of resampling iterations compared to the default settings.


```{r eval=T, echo=T}

ECT_res <- ECT(
  dat,
  factor_name = "example",
  num_snp_cutoff = 3,
  snp_fdr_cutoff = 0.2,
  seeds = 1000,
  resample_stages = c(10, 100, 10000),
  p_thresholds = c(0.1, 0.001),
  col_beta_exposure = "beta.exposure",
  col_beta_outcome = "beta.outcome",
  col_pval_exposure = "pval.exposure"
)

print(ECT_res)
```







